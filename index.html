<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=3.0, user-scalable=yes">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>🌳 Bayar Ailesi Soy Ağacı | Aile Ağacı</title>
    <meta name="description" content="Bayar Ailesi Soy Ağacı - Aile üyelerini keşfedin ve aile tarihçenizi inceleyin">
    <meta property="og:title" content="Bayar Ailesi Soy Ağacı">
    <meta property="og:description" content="Aile üyelerini keşfedin ve aile tarihçenizi inceleyin">
    <meta property="og:type" content="website">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            overflow-x: hidden;
            position: relative;
        }

        .bg-animation {
            position: fixed;
            width: 100%;
            height: 100%;
            top: 0;
            left: 0;
            z-index: -10;
            opacity: 0.3;
            pointer-events: none;
        }

        .leaf {
            position: absolute;
            width: 40px;
            height: 40px;
            opacity: 0;
            animation: falling 15s infinite linear;
            pointer-events: none;
            z-index: -9;
        }

        @keyframes falling {
            0% {
                opacity: 0;
                transform: translateY(-100px) rotate(0deg);
            }
            10% {
                opacity: 1;
            }
            90% {
                opacity: 1;
            }
            100% {
                opacity: 0;
                transform: translateY(calc(100vh + 100px)) rotate(360deg);
            }
        }

        .header {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            padding: 20px;
            text-align: center;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .header h1 {
            color: #764ba2;
            font-size: 24px;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .header .subtitle {
            color: #666;
            font-size: 14px;
            font-style: italic;
        }

        .stats {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-top: 15px;
            flex-wrap: wrap;
        }

        .stat {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 12px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
        }

        .controls {
            background: white;
            padding: 15px;
            margin: 10px;
            border-radius: 15px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        .search-box {
            width: 100%;
            padding: 16px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 16px;
            transition: all 0.3s;
            background: #f8f8f8;
            min-height: 44px;
            -webkit-appearance: none;
            touch-action: manipulation;
        }

        .search-box:focus {
            outline: none;
            border-color: #764ba2;
            background: white;
            box-shadow: 0 0 0 3px rgba(118, 75, 162, 0.1);
        }

        .filter-buttons {
            display: flex;
            gap: 10px;
            margin-top: 15px;
            overflow-x: auto;
            padding-bottom: 10px;
            -webkit-overflow-scrolling: touch;
            scrollbar-width: none;
            -ms-overflow-style: none;
        }
        
        .filter-buttons::-webkit-scrollbar {
            display: none;
        }

        .generation-filters {
            display: flex;
            gap: 8px;
            margin-top: 10px;
            overflow-x: auto;
            padding-bottom: 10px;
            -webkit-overflow-scrolling: touch;
            scrollbar-width: none;
            -ms-overflow-style: none;
        }
        
        .generation-filters::-webkit-scrollbar {
            display: none;
        }

        .generation-btn {
            padding: 8px 12px;
            border: none;
            background: #e8f4f8;
            color: #2c5aa0;
            border-radius: 15px;
            font-size: 11px;
            cursor: pointer;
            transition: all 0.2s ease;
            white-space: nowrap;
            min-width: 50px;
            min-height: 44px;
            display: flex;
            align-items: center;
            justify-content: center;
            -webkit-tap-highlight-color: rgba(44, 90, 160, 0.3);
            touch-action: manipulation;
            user-select: none;
            -webkit-user-select: none;
            position: relative;
            z-index: 10;
            flex-shrink: 0;
        }
        
        .generation-btn:active {
            background: #d0e8f0;
            transform: scale(0.98);
        }

        .generation-btn.active {
            background: #2c5aa0;
            color: white;
        }

        .filter-btn {
            padding: 10px 14px;
            border: none;
            background: #f0f0f0;
            border-radius: 20px;
            font-size: 13px;
            cursor: pointer;
            transition: all 0.2s ease;
            white-space: nowrap;
            min-height: 44px;
            min-width: 44px;
            display: flex;
            align-items: center;
            justify-content: center;
            -webkit-tap-highlight-color: rgba(102, 126, 234, 0.3);
            touch-action: manipulation;
            user-select: none;
            -webkit-user-select: none;
            position: relative;
            z-index: 10;
            flex-shrink: 0;
        }
        
        .filter-btn:active {
            background: #e0e0e0;
            transform: scale(0.98);
        }

        .filter-btn.active {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
        }

        .tree-container {
            padding: 20px 10px;
            min-height: 400px;
        }

        .generation {
            margin-bottom: 30px;
            animation: slideIn 0.5s ease-out;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .generation-title {
            background: rgba(255, 255, 255, 0.9);
            padding: 10px 15px;
            border-radius: 10px;
            margin-bottom: 15px;
            font-weight: bold;
            color: #764ba2;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .person-card {
            background: white;
            border-radius: 15px;
            padding: 18px;
            margin-bottom: 10px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            cursor: pointer;
            transition: all 0.2s ease;
            position: relative;
            overflow: hidden;
            -webkit-tap-highlight-color: rgba(118, 75, 162, 0.3);
            touch-action: manipulation;
            min-height: 44px;
            user-select: none;
            -webkit-user-select: none;
            z-index: 1;
        }
        
        .person-card:active {
            background: #f8f8f8;
            transform: scale(0.99);
        }

        .person-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 30%;
            height: 100%;
            background: linear-gradient(90deg, rgba(102, 126, 234, 0.15), transparent);
            pointer-events: none;
            z-index: -1;
        }

        .person-card.male::before {
            background: linear-gradient(90deg, rgba(74, 144, 226, 0.15), transparent);
        }

        .person-card.female::before {
            background: linear-gradient(90deg, rgba(233, 30, 99, 0.15), transparent);
        }

        .person-card.expanded {
            background: linear-gradient(135deg, #f8f8f8, #ffffff);
            box-shadow: 0 6px 20px rgba(0,0,0,0.15);
        }

        .person-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .person-name {
            font-size: 16px;
            font-weight: bold;
            color: #333;
            display: flex;
            align-items: center;
            gap: 8px;
            flex-wrap: wrap;
        }

        .person-year {
            font-size: 14px;
            color: #666;
        }

        .person-details {
            display: none;
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid #e0e0e0;
            animation: fadeIn 0.3s;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .person-details.show {
            display: block;
        }

        .detail-row {
            display: block;
            padding: 5px 0;
            font-size: 14px;
        }

        .detail-label {
            color: #666;
            font-weight: 500;
            margin-right: 8px;
        }

        .detail-value {
            color: #333;
        }

        .relations {
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px dashed #e0e0e0;
        }

        .relation-chip {
            display: inline-block;
            background: #f0f0f0;
            padding: 4px 10px;
            border-radius: 15px;
            font-size: 12px;
            margin: 2px;
        }

        .life-status {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 11px;
            margin-left: 5px;
        }

        .alive {
            background: #d4edda;
            color: #155724;
        }

        .deceased {
            background: #f8d7da;
            color: #721c24;
        }
        
        .floating-info {
            display: none;
        }

        .empty-state {
            text-align: center;
            padding: 50px 20px;
            color: white;
        }

        @media (max-width: 480px) {
            .header h1 {
                font-size: 20px;
            }
            
            .stat {
                font-size: 11px;
                padding: 8px 14px;
                min-height: 36px;
                display: flex;
                align-items: center;
            }
            
            .person-card {
                padding: 16px;
                margin-bottom: 12px;
            }
            
            .filter-btn {
                padding: 10px 12px;
                font-size: 12px;
                min-width: 40px;
            }
            
            .generation-btn {
                padding: 8px 10px;
                font-size: 10px;
                min-width: 45px;
            }
            
            .upload-btn, .save-btn {
                padding: 14px 18px;
                font-size: 13px;
            }
            
            .search-box {
                padding: 16px;
                font-size: 16px;
            }

            .person-name {
                font-size: 15px;
            }

            .person-year {
                font-size: 13px;
            }
        }

        .upload-section {
            position: fixed;
            bottom: 20px;
            left: 20px;
            z-index: 98;
            display: flex;
            gap: 10px;
            flex-direction: column;
        }

        .upload-btn, .save-btn {
            background: rgba(255, 255, 255, 0.9);
            color: #666;
            padding: 12px 16px;
            border: 1px solid #ddd;
            border-radius: 20px;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.2s ease;
            opacity: 0.7;
            position: relative;
            overflow: hidden;
            min-height: 44px;
            min-width: 44px;
            display: flex;
            align-items: center;
            justify-content: center;
            -webkit-tap-highlight-color: rgba(102, 126, 234, 0.3);
            touch-action: manipulation;
            user-select: none;
            -webkit-user-select: none;
            z-index: 99;
        }
        
        .upload-btn:active, .save-btn:active {
            background: #f0f0f0;
            transform: scale(0.98);
        }

        .upload-btn:hover, .save-btn:hover {
            opacity: 1;
            background: white;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .upload-btn.loading {
            background: #f0f0f0;
            cursor: not-allowed;
        }

        .upload-btn.loading::after {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.8), transparent);
            animation: loading 1.5s infinite;
        }

        @keyframes loading {
            0% { left: -100%; }
            100% { left: 100%; }
        }

        .save-btn {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border: none;
            display: none;
        }

        .save-btn.show {
            display: flex;
        }

        #fileInput {
            display: none;
        }

        .toast {
            position: fixed;
            bottom: 100px;
            left: 50%;
            transform: translateX(-50%) translateY(100px);
            background: rgba(0,0,0,0.8);
            color: white;
            padding: 12px 24px;
            border-radius: 25px;
            font-size: 14px;
            z-index: 1000;
            opacity: 0;
            transition: all 0.3s;
            max-width: 90%;
            text-align: center;
        }

        .toast.show {
            transform: translateX(-50%) translateY(0);
            opacity: 1;
        }

        .toast.error {
            background: rgba(220, 53, 69, 0.9);
        }

        .toast.success {
            background: rgba(40, 167, 69, 0.9);
        }
        
    </style>
</head>
<body>
    <div class="bg-animation">
        <div class="leaf" style="left: 10%; animation-delay: 0s;">🍃</div>
        <div class="leaf" style="left: 30%; animation-delay: 3s;">🍂</div>
        <div class="leaf" style="left: 50%; animation-delay: 6s;">🍃</div>
        <div class="leaf" style="left: 70%; animation-delay: 9s;">🍂</div>
        <div class="leaf" style="left: 90%; animation-delay: 12s;">🍃</div>
    </div>

    <div class="header">
        <h1>
            <span>🌳</span>
            <span>Bayar Ailesi Soy Ağacı</span>
            <span>🌳</span>
        </h1>
        <div class="subtitle">"Köklerimiz geçmişte, dallarımız gelecekte"</div>
        <div class="stats" id="stats">
            <span class="stat">👥 <span id="totalCount">0</span> Kişi</span>
            <span class="stat">👨‍👩‍👧‍👦 <span id="familyCount">0</span> Aile</span>
            <span class="stat">🎂 <span id="genCount">0</span> Nesil</span>
        </div>
    </div>

    <div class="upload-section">
        <input type="file" id="fileInput" accept=".xlsx,.xls,.csv">
        <button class="upload-btn" id="uploadBtn" type="button">
            📁 Excel Yükle
        </button>
        <button class="save-btn" id="saveBtn" type="button">
            💾 Kaydet
        </button>
    </div>

    <div class="controls">
        <input type="text" class="search-box" id="searchBox" placeholder="🔍 İsim, şehir veya meslek ara...">
        <div class="filter-buttons">
            <button class="filter-btn active" type="button" data-filter="all">Tümü</button>
            <button class="filter-btn" type="button" data-filter="alive">💚 Hayatta</button>
            <button class="filter-btn" type="button" data-filter="corum">📍 Çorum</button>
            <button class="filter-btn" type="button" data-filter="male">👨 Erkek</button>
            <button class="filter-btn" type="button" data-filter="female">👩 Kadın</button>
            <button class="filter-btn" type="button" data-filter="roots">🌳 Kökler</button>
        </div>
        <div class="generation-filters" id="generationFilters" style="display: none;">
        </div>
    </div>

    <div class="tree-container" id="treeContainer">
        <div class="empty-state">
            <p style="font-size: 50px; margin-bottom: 20px;">🌳</p>
            <h3>Aile Ağacınızı Yükleyin</h3>
            <p style="margin-top: 10px; opacity: 0.8;">Excel dosyanızı seçerek başlayın</p>
            <p style="margin-top: 5px; opacity: 0.6; font-size: 12px;">Desteklenen formatlar: .xlsx, .xls, .csv</p>
        </div>
    </div>

    <div class="toast" id="toast"></div>
    

    <script>
        let allPeople = [];
        let marriages = {};
        let currentFilter = 'all';
        let currentGeneration = 'all';
        let loadedData = null;
        let isXLSXLoaded = false;

        function debugLog(message, type = 'info') {
            console.log(`[${type.toUpperCase()}] ${message}`);
        }

        function loadXLSXLibrary() {
            return new Promise((resolve, reject) => {
                if (window.XLSX) {
                    resolve();
                    return;
                }
                const script = document.createElement('script');
                script.src = 'https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js';
                script.onload = () => {
                    isXLSXLoaded = true;
                    debugLog('XLSX kütüphanesi yüklendi');
                    resolve();
                };
                script.onerror = () => {
                    debugLog('XLSX kütüphanesi yüklenemedi', 'error');
                    reject(new Error('XLSX yüklenemedi'));
                };
                document.head.appendChild(script);
            });
        }

        function turkishToLower(str) {
            if (!str) return '';
            return str.toString().replace(/İ/g, 'i').replace(/I/g, 'ı').replace(/Ğ/g, 'ğ').replace(/Ü/g, 'ü').replace(/Ş/g, 'ş').replace(/Ö/g, 'ö').replace(/Ç/g, 'ç').toLowerCase();
        }

        function showToast(message, type = 'info') {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.className = `toast ${type}`;
            toast.classList.add('show');
            
            // Auto hide after different durations based on type
            const duration = type === 'success' ? 2000 : type === 'error' ? 4000 : 3000;
            setTimeout(() => toast.classList.remove('show'), duration);
        }

        function triggerFileUpload() {
            console.log('🚀 triggerFileUpload çağrıldı');
            const uploadBtn = document.getElementById('uploadBtn');
            const fileInput = document.getElementById('fileInput');
            
            if (!uploadBtn) {
                console.error('❌ Upload button bulunamadı!');
                return;
            }
            if (!fileInput) {
                console.error('❌ File input bulunamadı!');
                return;
            }
            
            uploadBtn.classList.add('loading');
            uploadBtn.textContent = '📥 Yükleniyor...';
            loadXLSXLibrary().then(() => {
                console.log('✅ XLSX kütüphanesi yüklendi, file input tıklanıyor');
                fileInput.click();
            }).catch(error => {
                console.error('❌ XLSX kütüphane hatası:', error);
                showToast('❌ Kütüphane yüklenemedi. Sayfayı yenileyin.', 'error');
            }).finally(() => {
                setTimeout(() => {
                    if (uploadBtn) {
                        uploadBtn.classList.remove('loading');
                        uploadBtn.textContent = '📁 Excel Yükle';
                    }
                }, 1000);
            });
        }

        function parseCSV(csvText) {
            const lines = csvText.split('\n').filter(line => line.trim());
            if (lines.length === 0) return [];
            const headers = lines[0].split(',').map(h => h.trim().replace(/"/g, ''));
            const data = [];
            for (let i = 1; i < lines.length; i++) {
                const values = lines[i].split(',').map(v => v.trim().replace(/"/g, ''));
                const obj = {};
                headers.forEach((header, index) => {
                    obj[header] = values[index] || '';
                });
                data.push(obj);
            }
            return data;
        }

        function setupEventListeners() {
            console.log('🔧 setupEventListeners çağrıldı');
            
            // Upload button
            const uploadBtn = document.getElementById('uploadBtn');
            console.log('📤 Upload button bulundu:', !!uploadBtn);
            if (uploadBtn) {
                uploadBtn.addEventListener('click', function(e) {
                    console.log('📤 Upload button tıklandı!');
                    e.preventDefault();
                    e.stopPropagation();
                    triggerFileUpload();
                });
                
                // iOS Safari fix
                uploadBtn.addEventListener('touchend', function(e) {
                    e.preventDefault();
                    this.click();
                });
            }

            // Save button
            const saveBtn = document.getElementById('saveBtn');
            console.log('💾 Save button bulundu:', !!saveBtn);
            if (saveBtn) {
                saveBtn.addEventListener('click', function(e) {
                    console.log('💾 Save button tıklandı!');
                    e.preventDefault();
                    e.stopPropagation();
                    saveWithData();
                });
                
                // iOS Safari fix
                saveBtn.addEventListener('touchend', function(e) {
                    e.preventDefault();
                    this.click();
                });
            }

            // Filter buttons
            const filterButtons = document.querySelectorAll('.filter-btn');
            console.log('🔍 Filter buttonlar bulundu:', filterButtons.length);
            filterButtons.forEach((button, index) => {
                console.log(`🔍 Filter button ${index + 1} event listener eklendi`);
                button.addEventListener('click', function(e) {
                    console.log('🔍 Filter button tıklandı:', this.getAttribute('data-filter'));
                    e.preventDefault();
                    e.stopPropagation();
                    const filter = this.getAttribute('data-filter');
                    if (filter) {
                        filterBy(filter, this);
                    }
                });
                
                // iOS Safari fix
                button.addEventListener('touchend', function(e) {
                    e.preventDefault();
                    this.click();
                });
            });

            // File input
            const fileInput = document.getElementById('fileInput');
            if (fileInput) {
                fileInput.addEventListener('change', handleFileChange);
            }

            // Search box
            const searchBox = document.getElementById('searchBox');
            if (searchBox) {
                searchBox.addEventListener('input', renderTree);
            }
        }

        function handleFileChange(e) {
            const file = e.target.files[0];
            if (!file) return;

            if (file.size > 10 * 1024 * 1024) {
                showToast('❌ Dosya çok büyük (max 10MB)', 'error');
                return;
            }

            const validTypes = ['application/vnd.openxmlformats-officedocument.spreadsheetml.sheet', 'application/vnd.ms-excel', 'text/csv'];
            if (!validTypes.includes(file.type) && !file.name.match(/\.(xlsx|xls|csv)$/i)) {
                showToast('❌ Geçersiz dosya formatı. Excel (.xlsx, .xls) veya CSV kullanın.', 'error');
                return;
            }

            try {
                showToast('📥 Dosya işleniyor...', 'info');
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        let jsonData;
                        if (file.name.toLowerCase().endsWith('.csv')) {
                            jsonData = parseCSV(e.target.result);
                        } else {
                            if (!window.XLSX) throw new Error('XLSX kütüphanesi yüklenmemiş');
                            const data = new Uint8Array(e.target.result);
                            const workbook = XLSX.read(data, { type: 'array', cellDates: true, cellNF: false, cellStyles: false });
                            const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                            jsonData = XLSX.utils.sheet_to_json(firstSheet, { header: 1, defval: '', blankrows: false });
                            if (jsonData.length > 0) {
                                const headers = jsonData[0];
                                const rows = jsonData.slice(1);
                                jsonData = rows.map(row => {
                                    const obj = {};
                                    headers.forEach((header, index) => {
                                        obj[header] = row[index] || '';
                                    });
                                    return obj;
                                });
                            }
                        }
                        if (jsonData.length === 0) throw new Error('Dosyada veri bulunamadı');
                        loadedData = jsonData;
                        processData(jsonData);
                        document.getElementById('saveBtn').classList.add('show');
                        showToast('✅ Başarıyla yüklendi!', 'success');
                    } catch (error) {
                        console.error('Veri işleme hatası:', error);
                        showToast(`❌ Veri işleme hatası: ${error.message}`, 'error');
                    }
                };
                reader.onerror = () => showToast('❌ Dosya okunamadı', 'error');
                if (file.name.toLowerCase().endsWith('.csv')) {
                    reader.readAsText(file, 'UTF-8');
                } else {
                    reader.readAsArrayBuffer(file);
                }
            } catch (error) {
                console.error('Genel hata:', error);
                showToast(`❌ Hata: ${error.message}`, 'error');
            }
        }

        function processData(data) {
            const validData = data.filter(person => {
                const name = person['Ad Soyad'] || person['İsim'] || person['Name'] || '';
                return name && name.toString().trim() !== '' && name.toString().trim() !== 'undefined';
            });

            const peopleMap = {};
            validData.forEach((person, index) => {
                const personId = (person['ID'] || person['id'] || index).toString();
                const name = (person['Ad Soyad'] || person['İsim'] || person['Name'] || '').toString().trim();
                const mainId = personId.replace(/[A-Za-z]+$/, '');
                if (!peopleMap[mainId]) {
                    peopleMap[mainId] = {
                        id: personId, mainId: mainId, name: name,
                        gender: person['Cinsiyet'] || person['Gender'] || '',
                        birthYear: parseInt(person['Doğum Yılı'] || person['Birth Year'] || 0) || '',
                        phone: person['Telefon'] || person['Phone'] || '',
                        email: person['E-posta'] || person['Email'] || '',
                        job: person['Meslek'] || person['Job'] || '',
                        city: person['Şehir'] || person['City'] || '',
                        alive: (person['Hayatta'] || person['Alive'] || person['Hayatta(E-H)'] || '') === 'E',
                        marriageIds: [],
                        parentMarriageId: person['EBEVEYN Evlilik ID'] || person['Ebeveyn Evlilik ID'] || person['EBEVEYN ID'] || person['Parent Marriage ID'] || null
                    };
                    const marriageId = person['Evlilik ID'] || person['Marriage ID'] || '';
                    if (marriageId) peopleMap[mainId].marriageIds.push(marriageId);
                } else {
                    const marriageId = person['Evlilik ID'] || person['Marriage ID'] || '';
                    if (marriageId && !peopleMap[mainId].marriageIds.includes(marriageId)) {
                        peopleMap[mainId].marriageIds.push(marriageId);
                    }
                    if (!peopleMap[mainId].birthYear && person['Doğum Yılı']) peopleMap[mainId].birthYear = parseInt(person['Doğum Yılı']) || '';
                    if (!peopleMap[mainId].phone && person['Telefon']) peopleMap[mainId].phone = person['Telefon'];
                    if (!peopleMap[mainId].city && person['Şehir']) peopleMap[mainId].city = person['Şehir'];
                }
            });
            
            allPeople = Object.values(peopleMap);
            marriages = {};
            validData.forEach(person => {
                const marriageId = person['Evlilik ID'] || person['Marriage ID'] || '';
                if (marriageId) {
                    if (!marriages[marriageId]) marriages[marriageId] = { partners: [], children: [] };
                    const personId = (person['ID'] || person['id'] || '').toString();
                    const mainId = personId.replace(/[A-Za-z]+$/, '');
                    const personObj = allPeople.find(p => p.mainId === mainId);
                    if (personObj && !marriages[marriageId].partners.find(p => p.mainId === mainId)) {
                        marriages[marriageId].partners.push(personObj);
                    }
                }
            });

            allPeople.forEach(person => {
                if (person.parentMarriageId && marriages[person.parentMarriageId]) {
                    if (!marriages[person.parentMarriageId].children.find(c => c.mainId === person.mainId)) {
                        marriages[person.parentMarriageId].children.push(person);
                    }
                }
            });

            updateStats();
            updateGenerationFilters();
            renderTree();
        }

        function setupGenerationButtons() {
            const genButtons = document.querySelectorAll('.generation-btn');
            console.log('📅 Generation buttonlar bulundu:', genButtons.length);
            genButtons.forEach((button, index) => {
                console.log(`📅 Generation button ${index + 1} event listener eklendi`);
                button.addEventListener('click', function(e) {
                    console.log('📅 Generation button tıklandı:', this.getAttribute('data-generation'));
                    e.preventDefault();
                    e.stopPropagation();
                    const generation = this.getAttribute('data-generation');
                    if (generation) {
                        filterByGeneration(generation, this);
                    }
                });
            });
        }
        
        function updateGenerationFilters() {
            if (allPeople.length === 0) return;
            const generations = new Set();
            allPeople.forEach(person => {
                if (person.birthYear && person.birthYear > 1800) {
                    generations.add(Math.floor(person.birthYear / 10) * 10);
                }
            });
            const sortedGenerations = Array.from(generations).sort((a, b) => a - b);
            if (sortedGenerations.length > 1) {
                const container = document.getElementById('generationFilters');
                let html = '<button class="generation-btn active" type="button" data-generation="all">Tüm Nesiller</button>';
                sortedGenerations.forEach(gen => {
                    html += `<button class="generation-btn" type="button" data-generation="${gen}">${gen}'lar</button>`;
                });
                container.innerHTML = html;
                container.style.display = 'flex';
                setTimeout(setupGenerationButtons, 100);
            }
        }
        
        function filterByGeneration(generation, clickedButton) {
            currentGeneration = generation;
            document.querySelectorAll('.generation-btn').forEach(btn => btn.classList.remove('active'));
            if (clickedButton) clickedButton.classList.add('active');
            renderTree();
        }

        function updateStats() {
            document.getElementById('totalCount').textContent = allPeople.length;
            document.getElementById('familyCount').textContent = Object.keys(marriages).length;
            const birthYears = allPeople.map(p => p.birthYear).filter(y => y && y > 1800);
            if (birthYears.length > 0) {
                const range = Math.max(...birthYears) - Math.min(...birthYears);
                const generations = Math.ceil(range / 25) || 1;
                document.getElementById('genCount').textContent = generations;
            }
        }

        function renderTree() {
            const container = document.getElementById('treeContainer');
            if (allPeople.length === 0) {
                container.innerHTML = `<div class="empty-state"><p style="font-size: 50px; margin-bottom: 20px;">🌳</p><h3>Aile Ağacınızı Yükleyin</h3><p style="margin-top: 10px; opacity: 0.8;">Excel dosyanızı seçerek başlayın</p></div>`;
                return;
            }
            const generations = {};
            const filtered = filterPeople();
            filtered.forEach(person => {
                const decade = person.birthYear ? Math.floor(person.birthYear / 10) * 10 : 'Bilinmeyen';
                if (!generations[decade]) generations[decade] = [];
                generations[decade].push(person);
            });
            const sortedGenerations = Object.keys(generations).sort((a, b) => {
                if (a === 'Bilinmeyen') return 1; if (b === 'Bilinmeyen') return -1; return a - b;
            });
            let html = '';
            sortedGenerations.forEach(gen => {
                const genTitle = gen === 'Bilinmeyen' ? 'Doğum Yılı Bilinmeyenler' : `${gen}'lar`;
                html += `<div class="generation"><div class="generation-title">📅 ${genTitle}</div>${generations[gen].map(person => createPersonCard(person)).join('')}</div>`;
            });
            container.innerHTML = html || '<div class="empty-state">Sonuç bulunamadı</div>';
            
            // Setup person card click handlers
            setupPersonCardHandlers();
        }

        function setupPersonCardHandlers() {
            const personCards = document.querySelectorAll('.person-card');
            personCards.forEach(card => {
                // Remove any existing listeners
                card.replaceWith(card.cloneNode(true));
            });
            
            // Re-select after cloning
            const newPersonCards = document.querySelectorAll('.person-card');
            newPersonCards.forEach(card => {
                card.addEventListener('click', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    toggleDetails(this);
                });
                
                // iOS Safari touchend fix
                card.addEventListener('touchend', function(e) {
                    e.preventDefault();
                    this.click();
                });
            });
        }

        function createPersonCard(person) {
            const genderClass = person.gender === 'E' ? 'male' : person.gender === 'K' ? 'female' : '';
            const statusClass = person.alive ? 'alive' : 'deceased';
            const statusText = person.alive ? 'Hayatta' : 'Vefat';
            const age = (person.birthYear && person.alive) ? (new Date().getFullYear() - person.birthYear + ' yaş') : '';
            
            let parents = [];
            if (person.parentMarriageId && marriages[person.parentMarriageId]) {
                parents = marriages[person.parentMarriageId].partners.map(p => p.name);
            }

            let spouses = [];
            let marriageIdsArray = Array.isArray(person.marriageIds) ? person.marriageIds : (person.marriageIds ? [person.marriageIds] : []);
            if (marriageIdsArray.length > 0) {
                marriageIdsArray.forEach((marriageId, index) => {
                    if (marriages[marriageId]) {
                        const partner = marriages[marriageId].partners.find(p => p.mainId !== person.mainId);
                        if (partner) {
                            const orderText = marriageIdsArray.length > 1 ? ` (${index + 1}. evlilik)` : '';
                            spouses.push(partner.name + orderText);
                        }
                    }
                });
            }

            let allChildren = [];
            if (marriageIdsArray.length > 0) {
                marriageIdsArray.forEach(marriageId => {
                    if (marriages[marriageId] && marriages[marriageId].children) {
                        marriages[marriageId].children.forEach(child => {
                            if (!allChildren.includes(child.name)) allChildren.push(child.name);
                        });
                    }
                });
            }
            
            return `
                <div class="person-card ${genderClass}">
                    <div class="person-header">
                        <div class="person-name">
                            <span>${person.name}</span>
                            <span class="life-status ${statusClass}">${statusText}</span>
                            ${marriageIdsArray.length > 1 ? `<span style="background: #f0f0f0; padding: 2px 6px; border-radius: 10px; font-size: 11px; margin-left: 5px;">👰 ${marriageIdsArray.length} evlilik</span>` : ''}
                        </div>
                        <div class="person-year">${person.birthYear || ''} ${age ? `(${age})` : ''}</div>
                    </div>
                    <div class="person-details">
                        ${person.job ? `<div class="detail-row"><span class="detail-label">💼 Meslek:</span><span class="detail-value">${person.job}</span></div>` : ''}
                        ${person.city ? `<div class="detail-row"><span class="detail-label">📍 Şehir:</span><span class="detail-value">${person.city}</span></div>` : ''}
                        ${person.phone ? `<div class="detail-row"><span class="detail-label">📱 Telefon:</span><span class="detail-value">${person.phone}</span></div>` : ''}
                        ${person.email ? `<div class="detail-row"><span class="detail-label">📧 E-posta:</span><span class="detail-value">${person.email}</span></div>` : ''}
                        
                        ${parents.length > 0 || spouses.length > 0 || allChildren.length > 0 ? '<div class="relations">' : ''}
                        ${parents.map(parent => `<div class="relation-chip">👨‍👩‍👧‍👦 ${parent}</div>`).join('')}
                        ${spouses.map(spouse => `<div class="relation-chip">💑 ${spouse}</div>`).join('')}
                        ${allChildren.map(child => `<div class="relation-chip">👶 ${child}</div>`).join('')}
                        ${parents.length > 0 || spouses.length > 0 || allChildren.length > 0 ? '</div>' : ''}
                    </div>
                </div>
            `;
        }
        
        function toggleDetails(card) {
            const details = card.querySelector('.person-details');
            const isExpanded = details.classList.contains('show');

            document.querySelectorAll('.person-card.expanded').forEach(otherCard => {
                if (otherCard !== card) {
                    otherCard.classList.remove('expanded');
                    otherCard.querySelector('.person-details').classList.remove('show');
                }
            });

            details.classList.toggle('show');
            card.classList.toggle('expanded');

            if (card.classList.contains('expanded')) {
                setTimeout(() => {
                    card.scrollIntoView({ 
                        behavior: 'smooth', 
                        block: 'center',
                        inline: 'nearest'
                    });
                }, 100);
            }
        }

        function filterPeople() {
            let filtered = [...allPeople];
            const searchTerm = turkishToLower(document.getElementById('searchBox').value);
            if (searchTerm) {
                filtered = filtered.filter(p => 
                    turkishToLower(p.name).includes(searchTerm) ||
                    turkishToLower(p.city).includes(searchTerm) ||
                    turkishToLower(p.job).includes(searchTerm)
                );
            }
            if (currentGeneration !== 'all') {
                const genDecade = parseInt(currentGeneration);
                filtered = filtered.filter(p => {
                    if (!p.birthYear) return false;
                    return Math.floor(p.birthYear / 10) * 10 === genDecade;
                });
            }
            switch(currentFilter) {
                case 'alive': filtered = filtered.filter(p => p.alive); break;
                case 'male': filtered = filtered.filter(p => p.gender === 'E'); break;
                case 'female': filtered = filtered.filter(p => p.gender === 'K'); break;
                case 'corum': filtered = filtered.filter(p => p.city && turkishToLower(p.city).includes('çorum')); break;
                case 'roots': filtered = filtered.filter(p => !p.parentMarriageId); break;
            }
            return filtered;
        }

        function filterBy(type, clickedButton) {
            console.log('🔍 filterBy çağrıldı:', type);
            currentFilter = type;
            document.querySelectorAll('.filter-btn').forEach(btn => btn.classList.remove('active'));
            if (clickedButton) clickedButton.classList.add('active');
            renderTree();
        }

        function saveWithData() {
            console.log('💾 saveWithData çağrıldı, loadedData:', !!loadedData);
            if (!loadedData) {
                showToast('❌ Önce Excel dosyası yükleyin!', 'error');
                return;
            }
            try {
                const htmlContent = document.documentElement.outerHTML;
                const dataScript = `<script>window.embeddedData = ${JSON.stringify(loadedData)};<\/script>`;
                const finalHtml = htmlContent.replace('</body>', dataScript + '</body>');
                const blob = new Blob([finalHtml], { type: 'text/html;charset=utf-8' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `bayar_ailesi_soy_agaci_${new Date().toLocaleDateString('tr-TR').replace(/\./g, '_')}.html`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                showToast('💾 Dosya indirildi!', 'success');
            } catch (error) {
                console.error('Kaydetme hatası:', error);
                showToast('❌ Kaydetme hatası', 'error');
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            debugLog('🚀 Sayfa ve DOM hazır, olay yöneticileri kuruluyor...');

            // Setup all event listeners
            setupEventListeners();

            // Check for embedded data
            if (window.embeddedData) {
                debugLog('📊 Gömülü veri bulundu, işleniyor...');
                loadedData = window.embeddedData;
                processData(window.embeddedData);
                const saveBtn = document.getElementById('saveBtn');
                const uploadBtn = document.getElementById('uploadBtn');
                if (saveBtn) saveBtn.style.display = 'none';
                if (uploadBtn) {
                    uploadBtn.textContent = '✅ Veri Yüklü';
                    uploadBtn.style.opacity = '0.5';
                    uploadBtn.style.cursor = 'default';
                    uploadBtn.disabled = true;
                }
                showToast('✅ Veri otomatik yüklendi!', 'success');
            } else {
                debugLog('📚 XLSX kütüphanesi ön yükleniyor...');
                loadXLSXLibrary().catch(err => {
                    debugLog('⚠️ XLSX ön yükleme başarısız: ' + err.message);
                });
            }
        });

        // Error handling
        window.addEventListener('error', e => {
            console.error('JavaScript Error:', e.message, e.filename, e.lineno);
            debugLog(`JavaScript hatası: ${e.message}`, 'error');
        });
        
        window.addEventListener('unhandledrejection', e => {
            console.error('Promise rejected:', e.reason);
            debugLog(`Promise hatası: ${e.reason}`, 'error');
        });

        // Prevent iOS safari bounce effect and improve touch handling
        document.addEventListener('touchmove', function(e) {
            // Allow scrolling in specific containers
            if (e.target.closest('.tree-container, .filter-buttons, .generation-filters, .search-box')) {
                return;
            }
            e.preventDefault();
        }, { passive: false });
        
        // Prevent double-tap zoom on buttons
        document.addEventListener('touchend', function(e) {
            if (e.target.closest('button, .person-card')) {
                e.preventDefault();
            }
        }, { passive: false });
    </script>
</body>
</html>